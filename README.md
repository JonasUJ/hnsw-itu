# hnsw-itu
`hnsw-itu` is a Rust implementation of the [HNSW](https://arxiv.org/ftp/arxiv/papers/1603/1603.09320.pdf) approach to K-nearest neighbor problem on binary sketches. This is a bachelor's thesis and therefore by no means suited for use in a real world project.

The project is structured into two crates:
- `hnsw-itu` contains the implementation and api.
- `hnsw-itu-cli`, located in the `cli` directory, is a runnable CLI that can build/query hnsw indices from HDF5 files.

### Using the CLI
The CLI requires installing the `libhdf5-serial-dev` package through some package manager.
```sh
sudo apt-get install libhdf5-serial-dev
```
For best results, build the `hnsw-itu-cli` (in the `cli` directory) project with
```sh
RUSTFLAGS="-Ctarget-cpu=native" cargo build --release
```
which will generate an executable `target/release/hnsw-itu`. Alternatively, running the CLI with
```sh
RUSTFLAGS="-Ctarget-cpu=native" cargo run --release -- <hnsw-itu args>
```
is also an option.

#### help
The `help` subcommand shows an overview of all subcommands. Giving `help` also takes a subcommand as an argument which will show more details.
```
$ hnsw-itu help
CLI wrapper for hnsw-itu

Usage: hnsw-itu [OPTIONS] <COMMAND>

Commands:
  query         Create index from dataset, query it and generate result file
  index         Index dataset and generate result file used for queries
  query-index   Query an index file generated by the `index` command and generate result file
  ground-truth  Generate ground truth from a dataset given a set of queries
  inspect       Read information from index
  help          Print this message or the help of the given subcommand(s)

Options:
  -v, --verbose...  Increase logging verbosity
  -q, --quiet...    Decrease logging verbosity
  -h, --help        Print help
  -V, --version     Print version
```

#### query

Example of querying a binary sketch dataset. This combines the `index` and `query-index` commands.
```sh
$ hnsw-itu query \
    --datafile laion2B-en-hammingv2-n=10M.h5 \
    --queryfile public-queries-10k-hammingv2.h5 \

    # Some optional arguments
    --indexfile 10M.idx \ # Save the index to a file
    --outfile result.h5 \ # Results of query
    -vvv \      # Verbose output
    -e 64 \     # EF/beamwidth during search
    -c 96 \     # EF/beamwidth during index construction
    -m 24 \     # Desired number of connections for each node
    -M 256 \    # Maximum number of connections for each node
```

#### index

Create an index and save it to a file.
```sh
$ hnsw-itu index \
    --datafile laion2B-en-hammingv2-n=10M.h5 \

    # Some optional arguments
    --outfile 10M.idx \ # Save the index to a file (default: index.idx)
    -vvv \      # Verbose output
    -c 96 \     # EF/beamwidth during index construction
    -m 24 \     # Desired number of connections for each node
    -M 256 \    # Maximum number of connections for each node
```

#### query-index

Query and existing index
```sh
$ hnsw-itu index \
    --indexfile 10M.idx \
    --queryfile public-queries-10k-hammingv2.h5 \

    # Some optional arguments
    -vvv \      # Verbose output
    -e 64 \     # EF/beamwidth during search
```

### Expected output

This query resulted in a recall of 0.93356

```log
$ hnsw-itu query --datafile laion2B-en-hammingv2-n=10M.h5 --queryfile public-queries-10k-hammingv2.h5 --indexfile 10M.idx -vvv -e 64 -c 96 -m 24 -M 256
22:35:27 DEBUG hnsw_itu: Logging logging_level=LevelFilter::DEBUG
22:35:27  INFO build_index: hnsw_itu: Opening path="laion2B-en-hammingv2-n=10M.h5"
22:35:27  INFO build_index: hnsw_itu: Building index size=10120191 algorithm=Hnsw single_threaded=false
22:35:35 DEBUG build_index: hnsw_itu: 0% count=100000
22:35:37 DEBUG build_index: hnsw_itu: 1% count=200000
22:35:41 DEBUG build_index: hnsw_itu: 2% count=300000
# Snip
22:44:47 DEBUG build_index: hnsw_itu: 97% count=9900000
22:44:54 DEBUG build_index: hnsw_itu: 98% count=10000000
22:45:01 DEBUG build_index: hnsw_itu: 99% count=10100000
22:45:02  INFO build_index: hnsw_itu: Total build time: 575.21242181s, per element: 56.838us
22:45:02  INFO write_index: hnsw_itu: Serializing path="10M.idx" size=10120191
22:45:54  INFO query_index: hnsw_itu: Opening path="public-queries-10k-hammingv2.h5"
22:45:54  INFO query_index: hnsw_itu: Start querying k=10 ef=64 single_threaded=false
22:45:54 DEBUG query_index:knns{k=10 ef=64}: hnsw_itu::index: threads=16
22:45:54  INFO query_index: hnsw_itu: Total query time: 378.697421ms, per query: 37.869us
22:45:54  INFO write_result: hnsw_itu: Writing result path="result.h5" sort=false
22:45:54  INFO write_result: hnsw_itu: Writing result attributes data="hamming" size="10M" algo="Hnsw" buildtime=575.21242181 querytime=0.378697421 params="index=(efc=96,m=24,M=256),query=(N/A)"
```

